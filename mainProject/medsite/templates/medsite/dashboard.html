<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MedSite Heart Monitor</title>

  <style>
    :root{
      --black:#000;
      --muted:#6b6b6b;

      --good:#16a34a;   /* green */
      --warn:#f59e0b;   /* amber */
      --bad:#dc2626;    /* red */
      --low:#2563eb;    /* blue */
      --neutral:#111827;/* near-black */
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#fff;
      color:#000;
    }
    .wrap{
      padding:28px 36px;
      display:flex;
      gap:30px;
      align-items:flex-start;
    }

    /* LEFT */
    .left{
      width: 440px;
      min-width: 320px;
    }
    h1{
      margin:0 0 18px 0;
      font-size:40px;
      letter-spacing:0.2px;
    }
    .kv{
      font-size:22px;
      margin:10px 0;
      line-height:1.25;
    }
    .kv b{ font-weight:800; }
    .val{
      font-weight:800;
    }
    .good{ color:var(--good); }
    .warn{ color:var(--warn); }
    .bad{  color:var(--bad);  }
    .low{  color:var(--low);  }
    .neutral{ color:var(--neutral); }

    .muted{
      margin-top:14px;
      color:var(--muted);
      font-size:14px;
    }
    pre{
      margin-top:14px;
      font-size:12px;
      color:#222;
      white-space:pre-wrap;
    }

    /* RIGHT */
    .right{
      flex:1;
      min-width: 560px;
    }
    .topbar{
      display:flex;
      justify-content:flex-end;
      margin-bottom:10px;
    }
    select{
      font-size:14px;
      padding:8px 12px;
      border:3px solid var(--black);
      background:#fff;
      outline:none;
      font-weight:600;
      min-width: 200px;
    }
    .chartBox{
      border:4px solid var(--black);
      height: 520px;
      padding: 14px;
      box-sizing:border-box;
      background:#fff;
    }
    canvas{ width:100% !important; height:100% !important; }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <!-- LEFT PANEL -->
    <div class="left">
      <h1>MedSite Heart Monitor</h1>

      <div class="kv"><span>IR:</span> <span id="ir" class="val neutral">0</span></div>
      <div class="kv"><b>Red:</b> <span id="red" class="val neutral">0</span></div>

      <div class="kv"><b>Heart Rate (BPM):</b> <span id="bpm" class="val neutral">N/A</span></div>
      <div class="kv"><b>Oxygen Saturation (SpO₂, est.):</b> <span id="spo2" class="val neutral">N/A</span></div>
      <div class="kv"><b>Blood Pressure (BP, est.):</b> <span id="bp" class="val neutral">N/A</span></div>
      <div class="kv"><b>Temperature (°C, est.):</b> <span id="temp" class="val neutral">N/A</span></div>

      <div class="muted">Last updated: <span id="updated">—</span></div>

      <pre id="dbg">{}</pre>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right">
      <div class="topbar">
        <select id="metric">
          <option value="bp_sbp" selected>Blood Pressure</option>
          <option value="bpm">Heart Rate</option>
          <option value="spo2">Oxygen Saturation</option>
          <option value="temp">Temperature</option>
          <option value="ir">IR</option>
          <option value="red">Red</option>
        </select>
      </div>

      <div class="chartBox">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

<script>
  const DEVICE_ID = "c3-001";         // ✅ single device
  const MAX_POINTS = 35;              // more professional history length

  const labels = [];
  const values = [];

  const el = (id) => document.getElementById(id);

  // ---------- Color rules ----------
  function statusClass(metric, v){
    if (v === null || v === undefined || Number.isNaN(v)) return "neutral";

    // BPM
    if (metric === "bpm"){
      if (v < 60) return "low";       // brady
      if (v <= 100) return "good";
      return "bad";                   // tachy
    }

    // SpO2
    if (metric === "spo2"){
      if (v >= 95) return "good";
      if (v >= 90) return "warn";
      return "bad";
    }

    // Temp (°C)
    if (metric === "temp"){
      if (v < 35.5) return "low";
      if (v <= 37.2) return "good";
      if (v <= 38.0) return "warn";
      return "bad";
    }

    // SBP (mmHg)
    if (metric === "bp_sbp"){
      if (v < 90) return "low";
      if (v <= 120) return "good";
      if (v <= 139) return "warn";
      return "bad";
    }

    // IR/Red (no clinical thresholds here)
    return "neutral";
  }

  function colorFor(metric, v){
    const cls = statusClass(metric, v);
    if (cls === "good") return "#16a34a";
    if (cls === "warn") return "#f59e0b";
    if (cls === "bad")  return "#dc2626";
    if (cls === "low")  return "#2563eb";
    return "#111827";
  }

  function setValueColor(id, cls){
    const node = el(id);
    node.classList.remove("good","warn","bad","low","neutral");
    node.classList.add(cls);
  }

  // ---------- Chart ----------
  const ctx = document.getElementById("chart").getContext("2d");

  let currentMetric = el("metric").value;

  const chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        data: values,
        borderWidth: 3,
        pointRadius: 3,
        pointHoverRadius: 5,
        tension: 0.25,

        // color-code points
        pointBackgroundColor: (c) => colorFor(currentMetric, c.raw),
        pointBorderColor: (c) => colorFor(currentMetric, c.raw),

        // color-code line segments
        segment: {
          borderColor: (c) => colorFor(currentMetric, c.p1.parsed.y)
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed.y;
              if (currentMetric === "bp_sbp") return ` SBP: ${v} mmHg`;
              if (currentMetric === "spo2") return ` SpO₂: ${v.toFixed(1)} %`;
              if (currentMetric === "temp") return ` Temp: ${v.toFixed(1)} °C`;
              if (currentMetric === "bpm")  return ` BPM: ${v}`;
              return ` ${v}`;
            }
          }
        }
      },
      scales: {
        x: {
          display: true,
          grid: { color: "rgba(0,0,0,0.08)" },
          ticks: {
            maxRotation: 0,
            autoSkip: true,
            maxTicksLimit: 8
          },
          title: { display: true, text: "Time" }
        },
        y: {
          display: true,
          grid: { color: "rgba(0,0,0,0.08)" },
          ticks: { precision: 0 },
          title: { display: true, text: "" },
          grace: "10%"
        }
      }
    }
  });

  function setYAxisTitle(metric){
    let t = "";
    if (metric === "bp_sbp") t = "SBP (mmHg)";
    else if (metric === "bpm") t = "BPM";
    else if (metric === "spo2") t = "SpO₂ (%)";
    else if (metric === "temp") t = "°C";
    else if (metric === "ir") t = "IR (raw)";
    else if (metric === "red") t = "Red (raw)";
    chart.options.scales.y.title.text = t;
  }

  function pickValue(d, metric){
    if (metric === "bp_sbp") return (d.sbp !== null && d.sbp !== undefined) ? Number(d.sbp) : null;
    const v = d[metric];
    if (v === null || v === undefined) return null;
    return Number(v);
  }

  async function update(){
    try{
      const url = `/api/latest/${encodeURIComponent(DEVICE_ID)}/?ts=${Date.now()}`;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) return;

      const d = await res.json();
      el("dbg").textContent = JSON.stringify(d, null, 2);

      // LEFT panel text values + color coding
      el("ir").textContent = d.ir ?? 0;
      el("red").textContent = d.red ?? 0;
      setValueColor("ir", "neutral");
      setValueColor("red", "neutral");

      if (d.bpm !== null && d.bpm !== undefined) {
        el("bpm").textContent = d.bpm;
        setValueColor("bpm", statusClass("bpm", Number(d.bpm)));
      } else {
        el("bpm").textContent = "N/A";
        setValueColor("bpm", "neutral");
      }

      if (d.spo2 !== null && d.spo2 !== undefined) {
        el("spo2").textContent = Number(d.spo2).toFixed(1) + " %";
        setValueColor("spo2", statusClass("spo2", Number(d.spo2)));
      } else {
        el("spo2").textContent = "N/A";
        setValueColor("spo2", "neutral");
      }

      const bpValid = (d.sbp !== null && d.sbp !== undefined && d.dbp !== null && d.dbp !== undefined);
      if (bpValid) {
        el("bp").textContent = `${d.sbp}/${d.dbp} mmHg`;
        setValueColor("bp", statusClass("bp_sbp", Number(d.sbp)));
      } else {
        el("bp").textContent = "N/A";
        setValueColor("bp", "neutral");
      }

      if (d.temp !== null && d.temp !== undefined) {
        el("temp").textContent = Number(d.temp).toFixed(1) + " °C";
        setValueColor("temp", statusClass("temp", Number(d.temp)));
      } else {
        el("temp").textContent = "N/A";
        setValueColor("temp", "neutral");
      }

      el("updated").textContent = d.created_at || "—";

      // CHART update
      const metric = currentMetric;
      const v = pickValue(d, metric);
      if (v !== null && !Number.isNaN(v)) {
        const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
        labels.push(t);
        values.push(v);

        if (labels.length > MAX_POINTS) { labels.shift(); values.shift(); }
        chart.update();
      }
    } catch(e){
      // ignore for now
    }
  }

  // Metric switching: reset chart history (clean) + update axis title
  el("metric").addEventListener("change", () => {
    currentMetric = el("metric").value;
    labels.length = 0;
    values.length = 0;
    setYAxisTitle(currentMetric);
    chart.update();
  });

  setYAxisTitle(currentMetric);
  update();
  setInterval(update, 1000);
</script>
</body>
</html>

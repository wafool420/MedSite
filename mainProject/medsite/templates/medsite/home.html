<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MedSite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-white">
<div class="container py-5">

  {% if user.is_authenticated %}
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold m-0">Doctor Dashboard</h2>

      <div class="d-flex align-items-center gap-3">
        {% if esp32_url %}
          <a href="{{ esp32_url }}" target="_blank" class="small text-decoration-none">
            ESP32 Page â†—
          </a>
        {% else %}
          <span class="small text-muted">No ESP32 URL configured.</span>
        {% endif %}


        <a class="btn btn-dark" href="{% url 'create_patient' %}">+ Create Patient</a>

        <form method="post" action="{% url 'logout' %}" class="m-0">
          {% csrf_token %}
          <button class="btn btn-outline-dark">Logout</button>
        </form>
      </div>
    </div>

    <!-- ACTIVE PATIENTS -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title fw-bold mb-3">Your Patients</h5>

        {% if patients %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Name</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for p in patients %}
                  <tr>
                    <td class="fw-semibold">{{ p.name }}</td>
                    <td class="text-end">
                      <a class="btn btn-dark btn-sm" href="{% url 'stats' p.id %}">Open Monitor</a>
                      <a class="btn btn-outline-dark btn-sm" href="{% url 'patient_detail' p.id %}">View</a>

                      <form method="post"
                            action="{% url 'archive_patient' p.id %}"
                            class="d-inline"
                            onsubmit="return confirm('Archive {{ p.name }}?');">
                        {% csrf_token %}
                        <button class="btn btn-outline-danger btn-sm">Archive</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-warning mb-0">
            No patients assigned to you yet.
          </div>
        {% endif %}
      </div>
    </div>

    <!-- ARCHIVED PATIENTS -->
    {% if archived_patients %}
      <div class="card shadow-sm mt-4">
        <div class="card-body">
          <h5 class="card-title fw-bold mb-3">Archived Patients</h5>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Name</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for p in archived_patients %}
                  <tr>
                    <td class="fw-semibold">
                      {{ p.name }}
                      {% if p.archived_at %}
                        <div class="small text-muted">Archived: {{ p.archived_at }}</div>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <a class="btn btn-outline-dark btn-sm" href="{% url 'patient_detail' p.id %}">View</a>

                      <form method="post"
                            action="{% url 'unarchive_patient' p.id %}"
                            class="d-inline"
                            onsubmit="return confirm('Restore {{ p.name }}?');">
                        {% csrf_token %}
                        <button class="btn btn-dark btn-sm">Restore</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="d-flex justify-content-end mt-3">
      <div class="text-end">
        <div class="small text-muted">Logged in as</div>
        <div class="fw-bold">{{ user.username }}</div>
      </div>
    </div>

  {% else %}
    <div class="d-flex align-items-center justify-content-center" style="min-height: 70vh;">
  <div class="text-center">
    <h1 class="fw-bold mb-3">Welcome to MedSite</h1>

    <div class="d-flex justify-content-center gap-2">
      <a class="btn btn-dark" href="{% url 'login' %}">Login</a>
      <a class="btn btn-outline-dark" href="{% url 'register' %}">Register</a>
    </div>
  </div>
</div>

  {% endif %}

</div>
</body>
</html>
